# Flox Build Environment for ComfyUI Packages
# ============================================
# This environment builds Python packages for ComfyUI that need to work
# with CUDA-enabled PyTorch. The key insight is that we DON'T include
# torch/torchvision as build dependencies - they're provided by the
# runtime environment (comfyui-repo).
#
# Nix expression builds are in .flox/pkgs/:
#   - comfyui-ultralytics.nix  (Ultralytics YOLO)
#   - timm.nix                 (PyTorch Image Models)
#   - segment-anything.nix     (Meta SAM)
#   - spandrel.nix             (Upscaler architectures)
#   - open-clip-torch.nix      (OpenAI CLIP)
#
# Usage:
#   flox build                    # Build all packages
#   flox build timm               # Build specific package
#
# The built packages can then be referenced in comfyui-repo via store-path.

version = 1

[install]
# Build dependencies
python.pkg-path = "python313Full"

[vars]
# Build configuration

[hook]
on-activate = '''
echo ""
echo "ComfyUI Packages Build Environment"
echo "==================================="
echo ""
echo "Packages in .flox/pkgs/:"
ls -1 "$FLOX_ENV_PROJECT/.flox/pkgs/"*.nix 2>/dev/null | xargs -I{} basename {} .nix | sed 's/^/  - /'
echo ""
echo "Build with: flox build <package-name>"
echo ""
echo "After building, reference in comfyui-repo manifest via store-path."
echo ""
'''

[profile]

[services]

[build]
# Nix expression builds are auto-discovered from .flox/pkgs/
# No explicit build definitions needed here

[options]
systems = ["x86_64-linux", "aarch64-linux", "x86_64-darwin", "aarch64-darwin"]
cuda-detection = true

# Overlays for platform-specific fixes
# pyarrow tests fail on darwin (test_timezone_absent) - see .flox/lib/pkgs.nix
